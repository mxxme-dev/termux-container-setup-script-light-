#!/bin/bash

cd ~
rm xx

echo "Installing termux-am"
pkg install termux-am -y &>/dev/null

termux-setup-storage & sleep 4 &>/dev/null

while true; do
    if [ -d ~/storage/shared ]; then
        break
    else
        echo "Storage permission denied"
    fi
    sleep 3
done

echo "Installing termux packages"
apt-get clean
apt-get update >/dev/null 2>&1
apt-get -y --with-new-pkgs -o Dpkg::Options::="--force-confdef" upgrade >/dev/null 2>&1
pkg install x11-repo -y &>/dev/null
pkg install pulseaudio -y &>/dev/null
pkg install xwayland -y &>/dev/null
pkg install wget -y &>/dev/null
pkg install tsu -y &>/dev/null
pkg install root-repo -y &>/dev/null
pkg install patchelf -y &>/dev/null
pkg install p7zip -y &>/dev/null
pkg install xorg-xrandr -y &>/dev/null
pkg install ncurses-utils -y &>/dev/null
pkg install hashdeep -y &>/dev/null
pkg install termux-x11-nightly -y &>/dev/null

if [ -e $PREFIX/glibc ]; then
    echo "Removing previous glibc..."
    rm -rf $PREFIX/glibc
fi

INSTALL_WOW64=1

echo "Installing mobox (WOW64 version)"

function wget-git-q {
    wget -q --retry-connrefused --tries=0 "https://gitlab.com/api/v4/projects/$PROJECT_ID/repository/files/$1/raw?ref=main" -O $2
    return $?
}

echo "Updating package manager"
mkdir -p $PREFIX/glibc/opt/package-manager/installed

echo "PROJECT_ID=54240888" > $PREFIX/glibc/opt/package-manager/token

. $PREFIX/glibc/opt/package-manager/token
if ! wget-git-q "package-manager" "$PREFIX/glibc/opt/package-manager/package-manager"; then
    echo "Download failed"
    return 1
fi

. $PREFIX/glibc/opt/package-manager/package-manager
sync-all

sync-package wine-9.3-vanilla-wow64

ln -sf $PREFIX/glibc/opt/scripts/mobox $PREFIX/bin/mobox

echo Installing ENV
pkg install proot-distro x11-repo virglrenderer mesa x11-repo termux-x11-nightly -y >/dev/null 2>&1
pkg update && pkg install xfce4 -y > /dev/null 2>&1
pkg install curl -y > /dev/null 2>&1
pkg install dpkg -y > /dev/null 2>&1
pkg install unzip -y > /dev/null 2>&1
pkg install tar -y > /dev/null 2>&1
cd ~
curl -L "https://cdn.discordapp.com/attachments/1366509759011885116/1369440384274403368/xDeb.tar?ex=681bde3e&is=681a8cbe&hm=97b35f3645628dfe38ef226679b5206f7431839d5bd690371f704a6dbed70078" -o xDeb.tar
tar -xf xDeb.tar
rm xDeb.tar
cd debs
dpkg vrg.deb && dpkg msa.deb
cd ~ && rm debs
cd ~/storage/downloads
pkg install xterm -y > /dev/null 2>&1

proot-distro install debian > /dev/null 2>&1
echo Debian.. setting-up

proot-distro login ubuntu -- bash -c "apt update && apt install -y virglrenderer libgl1-mesa-dri libgl1-mesa-glx && export GALLIUM_DRIVER=virpipe LIBGL_ALWAYS_SOFTWARE=1 DISPLAY=:1"

# proot-distro login ubuntu -- bash -c "dpkg -i /root/your-package.deb || apt install -f -y"

cat > copytodesktop.sh <<EOF
xterm -e "proot-distro login debian >/dev/null 2>&1"
EOF

clear 
echo done!!!!!!?!?!?!?!?!